
\chapter{Using the toppe sequence}

\section{Creating .mod files}
The TOPPE MATLAB repository (\matrep) includes the Matlab script {\tt \bf mat2mod.m} that writes rho, theta, gx, gy, and gz waveforms for a module to a .mod file.
Important notes and caveats:
\begin{itemize}
\item All waveforms in a module must have the same length, i.e., they must be padded with zeroes as needed.
\item Even if the module is not an RF excitation module, you must create a non-zero 'dummy' RF pulse to ensure that the .mod file will be loaded correctly on the scanner (hopefully this bug will be fixed in future releases). A simple hard RF pulse of low amplitude (e.g., 0.01 Gauss) seems to work well in most cases.
\item If the module is a readout module, data will be acquired every 4~$\mu$ for the entire duration of the waveforms in the .mod file. Depending on your readout trajectory, you may therefore need to discard some of the data (near the beginning and/or end of the module) before reconstructing.
\item If more than one readout .mod file is used, they must all be the same length (readout windows of different widths are not permitted).
\item For backward compatibility, the following must be done (this may change in future releases):
\begin{itemize}
	\item One of the readout .mod files must be named {\tt \bf readout.mod} 
	\item One of the RF excitation .mod files must be named {\tt \bf tipdown.mod} 
\end{itemize}
\end{itemize}


\section{Creating modules.txt}
{\tt modules.txt} can simply be created by hand, as specified above.


\section{Creating scanloop.txt}
The {\tt examples} folder in the TOPPE MATLAB repository (\matrep) contains several examples of how {\tt scanloop.txt} can be created.
Specifically, this is done in each example with the script {\tt \bf writeloop.m}.

We have determined empirically that to avoid data corruption, {\bf{\tt rhnslices} should be even}.
In addition, for now, avoid loading the {\tt dabslice}$=0$ slot with data. 
This means that there will be an odd number of slice slots available for useful data.


\section{Pre-viewing your sequence with {\tt playseq.m} }

We recommend displaying your sequence in Matlab using \texttt{playseq.m} before attempting to play it on the scanner, to verify that the correct modules are played out in the intended order.
\texttt{playseq.m} attempts to reproduce the exact module timing seen on the scanner, using CV values in the file \texttt{timing.txt}.
To use \texttt{scansim.m}, first use \texttt{readloop.m} to load a \texttt{scanloop.txt} file.
\texttt{scansim.m} and \texttt{readloop.m} can be found in the \texttt{matlab} directory.
As an example, do the following in the \texttt{example} directory:
\begin{lstlisting}
  >> addpath('../matlab/');
  >> d = readloop('scanloop.txt');
  >> startseqStart = 10000;
  >> startseqEnd = startseqStart+19; % display 20 consecutive startseq() calls
  % Load the .mod files listed in modules.txt and display part of sequence.
  % Exact timing information is loaded from 'timing.txt':
  >> scansim(startseqStart,startseqEnd,d);  
\end{lstlisting}

\myfigure{scansim}{1.0}{
Example sequence display created with \texttt{scansim.m}.
The sequence shown is a Bloch-Siegert B1 transmit mapping sequence with a 3D Cartesian readout.
Like the \texttt{toppe} and \texttt{toppe.psd.o} executables on the scanner, \texttt{scansim.m} loads \texttt{modules.txt} and the .mod files listed therein, and \texttt{scanloop.txt}.
In addition, \texttt{scansim.m} obtains exact sequence timing information from the file \texttt{timing.txt}.
}


%\section{Example scan included in the toppe distribution}
%The {\tt example} folder in the toppe distribution contains an example scan that combines Bloch-Siegert mapping and several SPGR acquisitions with different flip angle and TR, into one long scan. 


\section{Compiling the toppe pulse sequence}

The current version of \toppe~has been compiled for DV25, and has been tested on a GE Discovery MR750 3T scanner.
The\toppe~source code is in the \texttt{psd} directory.

To compile, follow the usual EPIC compilation steps.
First, check compiler version:
\vspace{-10pt}
\begin{lstlisting}
 which psdqmake
\end{lstlisting}
With the compiler at University of Michigan, the output is 
\vspace{-10pt}
\begin{lstlisting}
 /ESE_DV25.0_R01/psd/bin/psdqmake
\end{lstlisting}

Prepare directory for compilation and compile:
\vspace{-10pt}
\begin{lstlisting}
 prep_psd_dir
 psdqmake hw
\end{lstlisting}
This will create two executables: {\tt \psdname} and {\tt \psdname.psd.o}.




\section{Step-by-step scanner instructions}

Follow these steps to prescribe and run the toppe sequence:
\begin{enumerate}
	\item Copy {\tt \psdname} and {\tt \psdname.psd.o} to /usr/g/bin/ on the scanner host computer (console). This is only done once per scanner software upgrade.
	\item Copy {\tt modules.txt}, {\tt scanloop.txt}, and all .mod files to /usr/g/bin/.
	\item Required files:
	\begin{itemize}
		\item Make sure one of the readout (acquisition) .mod files is named {\tt readout.mod}.
		\item Make sure one of the RF excitation .mod files is named {\tt tipdown.mod}.
	\end{itemize}
	\item Prescribe the toppe sequence:
\begin{itemize}
	\item Select Axial 2D pulse sequence; Family: 'Gradient Echo'; pulse: 'GRE'; PSD Name: '\psdname'; click 'Accept'. (Fig.~\ref{fig:Rx1})
	\item Set slice thickness to the design value.
	\item Set slice spacing to 0.
	\item Set number of slices to {\tt rhnslices}$-1$ (see discussion of scanloop.txt above).
	\item Set shim of 'off'.
\end{itemize}
	\item Save and download the sequence, and run autoprescan.
	\item Click scan button. This will create a Pfile in /usr/g/mrraw/.
	\item To run a different TOPPE scan, simply overwrite modules.txt and scanloop.txt and make sure the .mod files for the next sequence exist in /usr/g/bin/. Then download the sequence (right-click) and hit Scan button. You do not need to prescribe a new sequence every time you load a new set of external files.
\end{enumerate}

\mywrapfigure{Rx1}{R}{0.98}{
Scanner prescription, screenshot 1.
}
\mywrapfigure{Rx2}{R}{0.98}{
Scanner prescription, screenshot 2.
}
\mywrapfigure{Rx3}{R}{0.98}{
Scanner prescription, with manual prescan window.
}


\section{Checklist}

Remember the following recommendations, which have been determined empirically:
\begin{itemize}
	\item It seems that {\tt rhnslices} should be even to avoid corrupt data.
	\item It seems safest to avoid storing data in the {\tt dabslice}$=$0 slot (in \texttt{loaddab()}), since data frames (``views'') for this slot are often flipped (reversed) with respect to the rest of the Pfile.
\end{itemize}


\section{Known bugs and limitations}
\begin{itemize}
	\item Data may be saved in \textbf{reverse order} (due to oeff and eeff flags), so keep an eye out for this. Inspect your raw data. %be sure to account for this if you use a script other than \texttt{loaddat\_ge.m} to load raw data from Pfile. (\texttt{loaddat\_ge.m} resides in the \texttt{matlab} folder in this distribution). 
	\item Auto prescan may not work, hence the use of manual prescan above.
	\item B1 scaling across multiple RF pulses has not been verified. May need to expand \texttt{rfpulse} struct.
	\item \toppe~ does not support cardiac/respiratory gating at the moment. If other groups have a need for this we believe gating can be easily added.
	\item \toppe~does not currently do any checks for SAR, PNS, or gradient heating.
	%\item Logical coordinate-frame transformations
\end{itemize}

